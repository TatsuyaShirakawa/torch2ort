# torch2ort

This repository provide a snippet to convert [PyTorch](https://github.com/pytorch/pytorch) models to .onnx format and run them on the [onnxruntime](https://github.com/pytorch/pytorch) backend.

A small benchmarking script and its results are provided (up to around 4x speedup on cpu!)

# requirements

- Pytorch

# usage

```python
import torch2ort

model = ...  # your PyTorch model
sample_inputs = ...  # input sample for the model (model(*args) must be a valid invocation of the model)


# export the model parameter
torch2ort(model, sample_inputs, 'model.onnx')
```

Tips:

- if the model has multiple inputs/outputs, specify the `input_names`/`output_names`.
- if the resulting model should run with dynamic input sizes, specify the `dynamic_axes`.

see [the PyTorch's official document](https://pytorch.org/docs/stable/onnx.html?highlight=onnx%20export#torch.onnx.export) for detail.


# benchmarking result

`benchmark.py` is provided as a sample scripts and it's also used as a benchmarking PyTorch vs ONNX Runtiem.

```shell
$ PYTHONPATH=. python benchmark.py
```

The following is the result on my environment.

- MacBook Pro 2017
- PyTorch 1.3.1
- Torch 1.1.0

|export to onnx|onnxruntime inference|onnxruntime loading|pytorch inference|pytorch loading|load speed up|inference speed up|
|-------------:|--------------------:|------------------:|----------------:|--------------:|------------:|-----------------:|
|        2.2070|              0.42583|            0.42883|           0.5994|        0.44724|       1.0429|             1.408|
|        6.1177|              1.84215|            0.16888|           2.9524|        0.11768|       0.6968|             1.603|
|        1.7160|              0.58440|            0.09453|           1.6935|        1.32386|      14.0048|             2.898|
|        4.3808|              1.37850|            0.35019|           2.5180|        2.25546|       6.4406|             1.827|
|        1.4774|              0.40551|            0.05136|           1.6396|        0.05806|       1.1305|             4.043|
|        0.3184|              0.33485|            0.01131|           0.8655|        0.01767|       1.5616|             2.585|
|        1.7765|              0.43656|            0.42634|           0.5960|        0.38581|       0.9049|             1.365|
|        5.8543|              1.30046|            0.15027|           2.3939|        0.11601|       0.7720|             1.841|
|        9.6598|              3.03974|            0.40951|           6.2203|        0.34708|       0.8475|             2.046|
|       10.8128|              1.99349|            0.52777|           3.7200|        0.18795|       0.3561|             1.866|
|       15.0545|              2.02734|            0.36232|           4.2327|        0.35986|       0.9932|             2.088|
|        1.6360|              0.57807|            0.08931|           1.6755|        0.92504|      10.3581|             2.898|
|        3.7426|              1.14362|            0.29553|           2.3237|        1.86055|       6.2956|             2.032|
|        1.1243|              0.32152|            0.03999|           0.7375|        0.03632|       0.9082|             2.294|
|        1.1722|              0.43304|            0.04261|           0.9723|        0.04872|       1.1434|             2.245|
|        1.1864|              0.53998|            0.05412|           1.2029|        0.05949|       1.0993|             2.228|
|        1.2301|              0.65228|            0.06867|           1.4937|        0.09159|       1.3338|             2.290|
|        1.2952|              0.38230|            0.05203|           1.3164|        0.05939|       1.1414|             3.443|
|        4.5139|              2.72635|            0.51199|           4.2549|        0.49662|       0.9700|             1.561|
|       11.3659|              5.87866|            0.77988|           7.0249|        0.71527|       0.9172|             1.195|
|        0.5495|              0.72334|            0.16050|           1.8154|        0.12627|       0.7867|             2.510|
|        1.2108|              1.41349|            0.25337|           2.1917|        0.27658|       1.0916|             1.551|
|        1.9305|              2.43847|            0.48120|           4.2606|        0.29389|       0.6107|             1.747|
|        8.3518|              6.41613|            1.21367|           9.9254|        1.08175|       0.8913|             1.547|
|        1.8549|              1.75889|            0.26937|           3.0439|        0.31205|       1.1585|             1.731|
|        1.7393|              0.07594|            0.03301|           0.3018|        0.01974|       0.5980|             3.974|
|        1.7057|              0.16136|            0.04415|           0.5281|        0.03666|       0.8304|             3.273|
|        1.8066|              0.26475|            0.05266|           0.6446|        0.03692|       0.7010|             2.435|
|        1.8022|              0.39984|            0.08632|           1.0049|        0.06027|       0.6982|             2.513|
|        0.3161|              0.34492|            0.01157|           0.9358|        0.01983|       1.7138|             2.713|
|        0.2815|              0.18770|            0.01190|           0.5042|        0.01613|       1.3554|             2.686|
|        3.7030|              2.79416|            0.96845|           4.3481|        1.57150|       1.6227|             1.556|
|        2.7523|              2.45614|            1.06806|           4.5134|        1.56147|       1.4620|             1.838|
|        3.3754|              3.84466|            0.88953|           6.8609|        1.64639|       1.8509|             1.785|
|        2.5092|              3.64675|            0.97073|           7.2506|        1.63934|       1.6888|             1.988|
|        3.6931|              4.50781|            0.93884|           7.7246|        1.53641|       1.6365|             1.714|
|        3.9243|              4.85293|            1.00441|           7.7898|        1.56938|       1.5625|             1.605|
|        3.8915|              5.70297|            1.15555|           9.5477|        1.67567|       1.4501|             1.674|
|        4.1089|              6.39963|            1.09992|           9.4404|        1.76509|       1.6048|             1.475|
|        7.0884|              7.54632|            1.68528|          11.6436|        1.55453|       0.9224|             1.543|
|        2.9327|              3.38474|            0.80651|           6.3942|        0.77188|       0.9571|             1.889|
